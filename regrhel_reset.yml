---
# This play registers several hosts with the curl command generated by Satellite

- name: "Register a list existing hosts"
  hosts: "{{ reghost_list }}"
  become: true

  tasks:

    - name: "Ensure the system is unsubscribed from the CDN"
      ansible.builtin.command: "subscription-manager unregister"
      ignore_errors: true
      register: result
      changed_when: result.rc == 0
      tags:
        - unregister

    - name: "Ensure the local cache is clean"
      ansible.builtin.command: "subscription-manager clean"
      ignore_errors: true
      register: result
      changed_when: result.rc == 0
      tags:
        - clean

    - name: "Restore the default rhsm.conf"
      ansible.builtin.template:
        src: "templates/rhsm.conf.j2"
        dest: "/etc/rhsm/rhsm.conf"
        owner: root
        group: root
        mode: "0644"
      tags:
        - rhsmconf


- name: "Register a list existing hosts"
  hosts: "localhost"
  connection: local
  become: true

  vars_files:
    - vars/satellite_vars.yml
    - vars/hostlist.yml
    - ~/rhisbuilder_vault.yml

  tasks:

    - name: "Dissociate the Satellite registration from them VM"
      ansible.builtin.include_tasks: "tasks/dissociate_host.yml"
      loop: "{{ hostlist }}"
      loop_control:
        loop_var: host

    - name: "Remove the hosts from Satellite configuration"
      ansible.builtin.include_tasks: "tasks/delete_host.yml"
      loop: "{{ hostlist }}"
      loop_control:
        loop_var: host
